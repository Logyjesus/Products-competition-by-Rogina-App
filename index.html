<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 1200px;
            width: 100%;
            padding: 40px;
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        h2 {
            color: #764ba2;
            margin: 30px 0 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }

        .auth-container {
            max-width: 400px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: bold;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin: 5px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .product-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
        }

        .product-card:hover {
            transform: translateY(-5px);
        }

        .product-card img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .product-card h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .product-card p {
            color: #666;
            margin-bottom: 15px;
        }

        .votes-count {
            background: #667eea;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            display: inline-block;
            margin: 10px 0;
            font-weight: bold;
        }

        .user-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 12px;
            text-align: right;
            border-bottom: 1px solid #ddd;
        }

        th {
            background: #667eea;
            color: white;
            font-weight: bold;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .winner-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            margin: 20px 0;
        }

        .winner-card h3 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .hidden {
            display: none;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-input-label {
            background: #f8f9fa;
            border: 2px dashed #667eea;
            color: #667eea;
            padding: 20px;
            border-radius: 8px;
            cursor: pointer;
            display: block;
            text-align: center;
            transition: all 0.3s;
        }

        .file-input-label:hover {
            background: #e8e9ff;
        }

        .loading {
            text-align: center;
            color: #667eea;
            margin: 20px 0;
        }

        .btn-edit {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .btn-delete {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            margin-right: 5px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s ease-in;
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .close {
            color: #aaa;
            float: left;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ† Ù…Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h1>

        <!-- Auth Screen -->
        <div id="authScreen">
            <div class="auth-container">
                <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ / Ø§Ù„ØªØ³Ø¬ÙŠÙ„</h2>
                <div class="form-group">
                    <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                    <input type="email" id="authEmail" placeholder="example@email.com">
                </div>
                <div class="form-group">
                    <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                    <input type="password" id="authPassword" placeholder="********">
                </div>
                <div class="form-group">
                    <label>Ø§Ù„Ø¯ÙˆØ± (Ù„Ù„ØªØ³Ø¬ÙŠÙ„ ÙÙ‚Ø·)</label>
                    <select id="authRole">
                        <option value="user">Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ø§Ø¯ÙŠ</option>
                        <option value="seller">Ø¨Ø§Ø¦Ø¹</option>
                        <option value="admin">Ù…Ø³Ø¤ÙˆÙ„</option>
                    </select>
                </div>
                <button onclick="login()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
                <button onclick="register()" class="btn-secondary">ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</button>
            </div>
        </div>

        <!-- Admin Dashboard -->
        <div id="adminScreen" class="hidden">
            <div class="user-info">
                <span>ğŸ‘¤ Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ <strong id="adminEmail"></strong> (Ù…Ø³Ø¤ÙˆÙ„)</span>
                <button onclick="logout()" class="btn-danger">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
            </div>
            
            <div class="tabs">
                <button onclick="showAdminTab('users')">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</button>
                <button onclick="showAdminTab('products')">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</button>
                <button onclick="showAdminTab('votes')">Ø§Ù„Ø£ØµÙˆØ§Øª</button>
                <button onclick="showAdminTab('winner')">Ø§Ù„ÙØ§Ø¦Ø²</button>
            </div>

            <div id="adminUsers" class="hidden">
                <h2>Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯</h2>
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <div class="form-group">
                        <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                        <input type="email" id="newUserEmail" placeholder="example@email.com">
                    </div>
                    <div class="form-group">
                        <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                        <input type="password" id="newUserPassword" placeholder="********">
                    </div>
                    <div class="form-group">
                        <label>Ø§Ù„Ø¯ÙˆØ±</label>
                        <select id="newUserRole">
                            <option value="user">Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ø§Ø¯ÙŠ</option>
                            <option value="seller">Ø¨Ø§Ø¦Ø¹</option>
                            <option value="admin">Ù…Ø³Ø¤ÙˆÙ„</option>
                        </select>
                    </div>
                    <button onclick="addNewUser()">â• Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</button>
                </div>

                <h2>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h2>
                <div class="form-group">
                    <input type="text" id="searchUsers" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø³ØªØ®Ø¯Ù…..." onkeyup="searchUsers()">
                </div>
                <div class="table-container">
                    <table id="usersTable">
                        <thead>
                            <tr>
                                <th>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</th>
                                <th>Ø§Ù„Ø¯ÙˆØ±</th>
                                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div id="adminProducts" class="hidden">
                <h2>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>
                <div class="form-group">
                    <input type="text" id="searchAdminProducts" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬..." onkeyup="searchAdminProducts()">
                </div>
                <div class="form-group">
                    <label>ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ø¨Ø§Ø¦Ø¹</label>
                    <select id="filterAdminSeller" onchange="filterAdminProducts()">
                        <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨Ø§Ø¦Ø¹ÙŠÙ†</option>
                    </select>
                </div>
                <div class="products-grid" id="adminProductsGrid"></div>
            </div>

            <div id="adminVotes" class="hidden">
                <h2>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ØµÙˆØ§Øª</h2>
                <div class="table-container">
                    <table id="votesTable">
                        <thead>
                            <tr>
                                <th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                                <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
                                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div id="adminWinner" class="hidden"></div>
        </div>

        <!-- Seller Dashboard -->
        <div id="sellerScreen" class="hidden">
            <div class="user-info">
                <span>ğŸ›’ Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ <strong id="sellerEmail"></strong> (Ø¨Ø§Ø¦Ø¹)</span>
                <button onclick="logout()" class="btn-danger">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
            </div>

            <h2>Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</h2>
            <div class="form-group">
                <label>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</label>
                <input type="text" id="productName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬">
            </div>
            <div class="form-group">
                <label>ÙˆØµÙ Ø§Ù„Ù…Ù†ØªØ¬</label>
                <textarea id="productDescription" placeholder="Ø£Ø¯Ø®Ù„ ÙˆØµÙ Ø§Ù„Ù…Ù†ØªØ¬"></textarea>
            </div>
            <div class="form-group">
                <label>ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬</label>
                <div class="file-input-wrapper">
                    <label for="productImage" class="file-input-label">
                        ğŸ“ Ø§Ø®ØªØ± ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬
                    </label>
                    <input type="file" id="productImage" accept="image/*">
                </div>
            </div>
            <button onclick="uploadProduct()">Ø±ÙØ¹ Ø§Ù„Ù…Ù†ØªØ¬</button>

            <h2>Ù…Ù†ØªØ¬Ø§ØªÙŠ</h2>
            <div class="form-group">
                <input type="text" id="searchSellerProducts" placeholder="ğŸ” Ø§Ø¨Ø­Ø« ÙÙŠ Ù…Ù†ØªØ¬Ø§ØªÙƒ..." onkeyup="searchSellerProducts()">
            </div>
            <div class="products-grid" id="sellerProductsGrid"></div>
        </div>

        <!-- User Dashboard -->
        <div id="userScreen" class="hidden">
            <div class="user-info">
                <span>ğŸ‘¤ Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ <strong id="userEmail"></strong> (Ù…Ø³ØªØ®Ø¯Ù…)</span>
                <button onclick="logout()" class="btn-danger">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
            </div>

            <div class="tabs">
                <button onclick="showUserTab('products')">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</button>
                <button onclick="showUserTab('winner')">Ø§Ù„ÙØ§Ø¦Ø²</button>
            </div>

            <div id="userProducts">
                <h2>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>
                <div class="form-group">
                    <input type="text" id="searchUserProducts" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬..." onkeyup="searchUserProducts()">
                </div>
                <div class="form-group">
                    <label>ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨</label>
                    <select id="filterUserProducts" onchange="filterUserProducts()">
                        <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</option>
                        <option value="most_voted">Ø§Ù„Ø£ÙƒØ«Ø± ØªØµÙˆÙŠØªØ§Ù‹</option>
                        <option value="least_voted">Ø§Ù„Ø£Ù‚Ù„ ØªØµÙˆÙŠØªØ§Ù‹</option>
                    </select>
                </div>
                <div class="products-grid" id="userProductsGrid"></div>
            </div>

            <div id="userWinner" class="hidden"></div>
        </div>

        <!-- Edit Product Modal -->
        <div id="editModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeEditModal()">&times;</span>
                <h2>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬</h2>
                <div class="form-group">
                    <label>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</label>
                    <input type="text" id="editProductName">
                </div>
                <div class="form-group">
                    <label>ÙˆØµÙ Ø§Ù„Ù…Ù†ØªØ¬</label>
                    <textarea id="editProductDescription"></textarea>
                </div>
                <div class="form-group">
                    <label>ØµÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                    <div class="file-input-wrapper">
                        <label for="editProductImage" class="file-input-label">
                            ğŸ“ Ø§Ø®ØªØ± ØµÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©
                        </label>
                        <input type="file" id="editProductImage" accept="image/*">
                    </div>
                </div>
                <button onclick="saveProductEdit()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
                <button onclick="closeEditModal()" class="btn-secondary">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://rclvmnkwlmcvlvdmvxak.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJjbHZtbmt3bG1jdmx2ZG12eGFrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2NDQxMzQsImV4cCI6MjA4MDIyMDEzNH0.5dxuyOBhyGd9H8Xt30Yxh3bfYjVOZ4YeAkcZOXXDWD0';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let currentUser = null;
        let allProducts = [];
        let allUsers = [];
        let editingProductId = null;

        // Authentication Functions
        async function register() {
            const email = document.getElementById('authEmail').value.trim();
            const password = document.getElementById('authPassword').value;
            const role = document.getElementById('authRole').value;

            if (!email || !password) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
                return;
            }

            try {
                const { data, error } = await supabase
                    .from('users')
                    .insert([{ email, password, role }])
                    .select();

                if (error) throw error;

                alert('ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­! ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
                document.getElementById('authEmail').value = '';
                document.getElementById('authPassword').value = '';
            } catch (error) {
                alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„: ' + error.message);
            }
        }

        async function login() {
            const email = document.getElementById('authEmail').value.trim();
            const password = document.getElementById('authPassword').value;

            if (!email || !password) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
                return;
            }

            try {
                const { data, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('email', email)
                    .eq('password', password)
                    .single();

                if (error) throw error;

                if (!data) {
                    alert('Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
                    return;
                }

                currentUser = data;
                showDashboard(data.role);
            } catch (error) {
                alert('Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: ' + error.message);
            }
        }

        function logout() {
            currentUser = null;
            document.getElementById('authScreen').classList.remove('hidden');
            document.getElementById('adminScreen').classList.add('hidden');
            document.getElementById('sellerScreen').classList.add('hidden');
            document.getElementById('userScreen').classList.add('hidden');
        }

        function showDashboard(role) {
            document.getElementById('authScreen').classList.add('hidden');
            
            if (role === 'admin') {
                document.getElementById('adminScreen').classList.remove('hidden');
                document.getElementById('adminEmail').textContent = currentUser.email;
                showAdminTab('users');
            } else if (role === 'seller') {
                document.getElementById('sellerScreen').classList.remove('hidden');
                document.getElementById('sellerEmail').textContent = currentUser.email;
                loadSellerProducts();
            } else {
                document.getElementById('userScreen').classList.remove('hidden');
                document.getElementById('userEmail').textContent = currentUser.email;
                showUserTab('products');
            }
        }

        // Admin Functions
        async function showAdminTab(tab) {
            document.getElementById('adminUsers').classList.add('hidden');
            document.getElementById('adminProducts').classList.add('hidden');
            document.getElementById('adminVotes').classList.add('hidden');
            document.getElementById('adminWinner').classList.add('hidden');

            if (tab === 'users') {
                document.getElementById('adminUsers').classList.remove('hidden');
                await loadAllUsers();
            } else if (tab === 'products') {
                document.getElementById('adminProducts').classList.remove('hidden');
                await loadAllProducts('admin');
                await loadSellerFilter();
            } else if (tab === 'votes') {
                document.getElementById('adminVotes').classList.remove('hidden');
                await loadAllVotes();
            } else if (tab === 'winner') {
                document.getElementById('adminWinner').classList.remove('hidden');
                await showWinner('admin');
            }
        }

        async function addNewUser() {
            const email = document.getElementById('newUserEmail').value.trim();
            const password = document.getElementById('newUserPassword').value;
            const role = document.getElementById('newUserRole').value;

            if (!email || !password) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
                return;
            }

            try {
                const { data, error } = await supabase
                    .from('users')
                    .insert([{ email, password, role }])
                    .select();

                if (error) throw error;

                alert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­!');
                document.getElementById('newUserEmail').value = '';
                document.getElementById('newUserPassword').value = '';
                await loadAllUsers();
            } catch (error) {
                alert('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ' + error.message);
            }
        }

        async function loadAllUsers() {
            try {
                const { data, error } = await supabase
                    .from('users')
                    .select('*');

                if (error) throw error;

                allUsers = data;
                displayUsers(data);
            } catch (error) {
                alert('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: ' + error.message);
            }
        }

        function displayUsers(users) {
            const tbody = document.querySelector('#usersTable tbody');
            tbody.innerHTML = '';

            users.forEach(user => {
                const row = tbody.insertRow();
                row.insertCell(0).textContent = user.email;
                row.insertCell(1).textContent = user.role === 'admin' ? 'Ù…Ø³Ø¤ÙˆÙ„' : user.role === 'seller' ? 'Ø¨Ø§Ø¦Ø¹' : 'Ù…Ø³ØªØ®Ø¯Ù…';
                
                const actionsCell = row.insertCell(2);
                actionsCell.innerHTML = `
                    <button class="btn-delete" onclick="deleteUser('${user.email}')">ğŸ—‘ï¸ Ø­Ø°Ù</button>
                `;
            });
        }

        async function deleteUser(email) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ')) {
                return;
            }

            try {
                const { error } = await supabase
                    .from('users')
                    .delete()
                    .eq('email', email);

                if (error) throw error;

                alert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­!');
                await loadAllUsers();
            } catch (error) {
                alert('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ' + error.message);
            }
        }

        function searchUsers() {
            const searchTerm = document.getElementById('searchUsers').value.toLowerCase();
            const filteredUsers = allUsers.filter(user => 
                user.email.toLowerCase().includes(searchTerm) ||
                user.role.toLowerCase().includes(searchTerm)
            );
            displayUsers(filteredUsers);
        }

        async function loadSellerFilter() {
            const { data: products, error } = await supabase
                .from('products')
                .select('seller_email');

            if (error) return;

            const sellers = [...new Set(products.map(p => p.seller_email))];
            const select = document.getElementById('filterAdminSeller');
            select.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨Ø§Ø¦Ø¹ÙŠÙ†</option>';
            
            sellers.forEach(seller => {
                const option = document.createElement('option');
                option.value = seller;
                option.textContent = seller;
                select.appendChild(option);
            });
        }

        function searchAdminProducts() {
            const searchTerm = document.getElementById('searchAdminProducts').value.toLowerCase();
            const filteredProducts = allProducts.filter(product => 
                product.name.toLowerCase().includes(searchTerm) ||
                product.description.toLowerCase().includes(searchTerm) ||
                product.seller_email.toLowerCase().includes(searchTerm)
            );
            displayProducts(filteredProducts, 'admin');
        }

        function filterAdminProducts() {
            const seller = document.getElementById('filterAdminSeller').value;
            if (seller) {
                const filteredProducts = allProducts.filter(p => p.seller_email === seller);
                displayProducts(filteredProducts, 'admin');
            } else {
                displayProducts(allProducts, 'admin');
            }
        }

        async function loadAllProducts(view) {
            try {
                const { data: products, error } = await supabase
                    .from('products')
                    .select('*');

                if (error) throw error;

                const { data: votes, error: votesError } = await supabase
                    .from('votes')
                    .select('*');

                if (votesError) throw votesError;

                allProducts = products.map(product => ({
                    ...product,
                    voteCount: votes.filter(v => v.product_id === product.id).length
                }));

                displayProducts(allProducts, view);
            } catch (error) {
                alert('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª: ' + error.message);
            }
        }

        function displayProducts(products, view) {
            const gridId = view === 'admin' ? 'adminProductsGrid' : 
                          view === 'seller' ? 'sellerProductsGrid' : 'userProductsGrid';
            const grid = document.getElementById(gridId);
            grid.innerHTML = '';

            products.forEach(product => {
                const card = createProductCard(product, product.voteCount, view);
                grid.appendChild(card);
            });
        }

        async function loadAllVotes() {
            try {
                const { data, error } = await supabase
                    .from('votes')
                    .select('*, products(name)');

                if (error) throw error;

                const tbody = document.querySelector('#votesTable tbody');
                tbody.innerHTML = '';

                data.forEach(vote => {
                    const row = tbody.insertRow();
                    row.insertCell(0).textContent = vote.user_email;
                    row.insertCell(1).textContent = vote.products?.name || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                    row.insertCell(2).textContent = new Date(vote.created_at).toLocaleString('ar-EG');
                });
            } catch (error) {
                alert('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ØµÙˆØ§Øª: ' + error.message);
            }
        }

        // Seller Functions
        async function uploadProduct() {
            const name = document.getElementById('productName').value.trim();
            const description = document.getElementById('productDescription').value.trim();
            const fileInput = document.getElementById('productImage');
            const file = fileInput.files[0];

            if (!name || !description || !file) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙˆØ§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø©');
                return;
            }

            try {
                const fileExt = file.name.split('.').pop();
                const fileName = `${Date.now()}_${Math.random().toString(36).substring(7)}.${fileExt}`;

                const { data: uploadData, error: uploadError } = await supabase.storage
                    .from('seller_uploads')
                    .upload(fileName, file);

                if (uploadError) throw uploadError;

                const { data: urlData } = supabase.storage
                    .from('seller_uploads')
                    .getPublicUrl(fileName);

                const { data, error } = await supabase
                    .from('products')
                    .insert([{
                        seller_email: currentUser.email,
                        name,
                        description,
                        file_url: urlData.publicUrl
                    }])
                    .select();

                if (error) throw error;

                alert('ØªÙ… Ø±ÙØ¹ Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­!');
                document.getElementById('productName').value = '';
                document.getElementById('productDescription').value = '';
                document.getElementById('productImage').value = '';
                await loadSellerProducts();
            } catch (error) {
                alert('Ø®Ø·Ø£ ÙÙŠ Ø±ÙØ¹ Ø§Ù„Ù…Ù†ØªØ¬: ' + error.message);
            }
        }

        async function loadSellerProducts() {
            try {
                const { data: products, error } = await supabase
                    .from('products')
                    .select('*')
                    .eq('seller_email', currentUser.email);

                if (error) throw error;

                const { data: votes, error: votesError } = await supabase
                    .from('votes')
                    .select('*');

                if (votesError) throw votesError;

                allProducts = products.map(product => ({
                    ...product,
                    voteCount: votes.filter(v => v.product_id === product.id).length
                }));

                displayProducts(allProducts, 'seller');
            } catch (error) {
                alert('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª: ' + error.message);
            }
        }

        function searchSellerProducts() {
            const searchTerm = document.getElementById('searchSellerProducts').value.toLowerCase();
            const filteredProducts = allProducts.filter(product => 
                product.name.toLowerCase().includes(searchTerm) ||
                product.description.toLowerCase().includes(searchTerm)
            );
            displayProducts(filteredProducts, 'seller');
        }

        function openEditModal(productId) {
            const product = allProducts.find(p => p.id === productId);
            if (!product) return;

            editingProductId = productId;
            document.getElementById('editProductName').value = product.name;
            document.getElementById('editProductDescription').value = product.description;
            document.getElementById('editProductImage').value = '';
            document.getElementById('editModal').style.display = 'block';
        }

        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
            editingProductId = null;
        }

        async function saveProductEdit() {
            const name = document.getElementById('editProductName').value.trim();
            const description = document.getElementById('editProductDescription').value.trim();
            const fileInput = document.getElementById('editProductImage');
            const file = fileInput.files[0];

            if (!name || !description) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„');
                return;
            }

            try {
                let updateData = { name, description };

                if (file) {
                    const fileExt = file.name.split('.').pop();
                    const fileName = `${Date.now()}_${Math.random().toString(36).substring(7)}.${fileExt}`;

                    const { data: uploadData, error: uploadError } = await supabase.storage
                        .from('seller_uploads')
                        .upload(fileName, file);

                    if (uploadError) throw uploadError;

                    const { data: urlData } = supabase.storage
                        .from('seller_uploads')
                        .getPublicUrl(fileName);

                    updateData.file_url = urlData.publicUrl;
                }

                const { data, error } = await supabase
                    .from('products')
                    .update(updateData)
                    .eq('id', editingProductId)
                    .select();

                if (error) throw error;

                alert('ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­!');
                closeEditModal();
                await loadSellerProducts();
            } catch (error) {
                alert('Ø®Ø·Ø£ ÙÙŠ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬: ' + error.message);
            }
        }

        async function deleteProduct(productId) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ØŸ')) {
                return;
            }

            try {
                const { error } = await supabase
                    .from('products')
                    .delete()
                    .eq('id', productId);

                if (error) throw error;

                alert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­!');
                await loadSellerProducts();
            } catch (error) {
                alert('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬: ' + error.message);
            }
        }

        // User Functions
        async function showUserTab(tab) {
            document.getElementById('userProducts').classList.add('hidden');
            document.getElementById('userWinner').classList.add('hidden');

            if (tab === 'products') {
                document.getElementById('userProducts').classList.remove('hidden');
                await loadAllProducts('user');
            } else if (tab === 'winner') {
                document.getElementById('userWinner').classList.remove('hidden');
                await showWinner('user');
            }
        }

        function searchUserProducts() {
            const searchTerm = document.getElementById('searchUserProducts').value.toLowerCase();
            const filteredProducts = allProducts.filter(product => 
                product.name.toLowerCase().includes(searchTerm) ||
                product.description.toLowerCase().includes(searchTerm) ||
                product.seller_email.toLowerCase().includes(searchTerm)
            );
            displayProducts(filteredProducts, 'user');
        }

        function filterUserProducts() {
            const filter = document.getElementById('filterUserProducts').value;
            let sortedProducts = [...allProducts];

            if (filter === 'most_voted') {
                sortedProducts.sort((a, b) => b.voteCount - a.voteCount);
            } else if (filter === 'least_voted') {
                sortedProducts.sort((a, b) => a.voteCount - b.voteCount);
            }

            displayProducts(sortedProducts, 'user');
        }

        async function voteForProduct(productId) {
            try {
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø£ÙŠ ØªØµÙˆÙŠØª Ø³Ø§Ø¨Ù‚ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
                const { data: existingVotes, error: checkError } = await supabase
                    .from('votes')
                    .select('*')
                    .eq('user_email', currentUser.email);

                if (checkError) throw checkError;

                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‚Ø¯ ØµÙˆØª Ù…Ù† Ù‚Ø¨Ù„
                if (existingVotes && existingVotes.length > 0) {
                    const previousVote = existingVotes[0];
                    
                    // Ø¥Ø°Ø§ ØµÙˆØª Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ù…Ù†ØªØ¬
                    if (previousVote.product_id === productId) {
                        alert('âš ï¸ Ù„Ù‚Ø¯ ØµÙˆØªØª Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ø§Ù„ÙØ¹Ù„!');
                        return;
                    }
                    
                    // Ø¥Ø°Ø§ ØµÙˆØª Ø¹Ù„Ù‰ Ù…Ù†ØªØ¬ Ø¢Ø®Ø±ØŒ Ø§Ø³Ø£Ù„Ù‡ Ø¥Ø°Ø§ Ø£Ø±Ø§Ø¯ ØªØºÙŠÙŠØ± ØµÙˆØªÙ‡
                    const changeVote = confirm('Ù„Ù‚Ø¯ ØµÙˆØªØª Ø¹Ù„Ù‰ Ù…Ù†ØªØ¬ Ø¢Ø®Ø± Ù…Ù† Ù‚Ø¨Ù„. Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØºÙŠÙŠØ± ØµÙˆØªÙƒ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ØŸ');
                    
                    if (!changeVote) {
                        return;
                    }
                    
                    // Ø­Ø°Ù Ø§Ù„ØµÙˆØª Ø§Ù„Ù‚Ø¯ÙŠÙ…
                    const { error: deleteError } = await supabase
                        .from('votes')
                        .delete()
                        .eq('user_email', currentUser.email);
                    
                    if (deleteError) throw deleteError;
                }

                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙˆØª Ø§Ù„Ø¬Ø¯ÙŠØ¯
                const { data, error } = await supabase
                    .from('votes')
                    .insert([{
                        user_email: currentUser.email,
                        product_id: productId,
                        created_at: new Date().toISOString()
                    }]);

                if (error) throw error;

                alert('âœ… ØªÙ… Ø§Ù„ØªØµÙˆÙŠØª Ø¨Ù†Ø¬Ø§Ø­!');
                await loadAllProducts('user');
            } catch (error) {
                alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØµÙˆÙŠØª: ' + error.message);
            }
        }

        // Helper Functions
        function createProductCard(product, voteCount, view) {
            const card = document.createElement('div');
            card.className = 'product-card';

            let buttons = '';
            if (view === 'user') {
                buttons = `<button onclick="voteForProduct(${product.id})">â¤ï¸ ØµÙˆÙ‘Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬</button>`;
            } else if (view === 'seller') {
                buttons = `
                    <button class="btn-edit" onclick="openEditModal(${product.id})">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
                    <button class="btn-delete" onclick="deleteProduct(${product.id})">ğŸ—‘ï¸ Ø­Ø°Ù</button>
                `;
            }

            card.innerHTML = `
                <img src="${product.file_url}" alt="${product.name}">
                <h3>${product.name}</h3>
                <p>${product.description}</p>
                <p><strong>Ø§Ù„Ø¨Ø§Ø¦Ø¹:</strong> ${product.seller_email}</p>
                <div class="votes-count">â¤ï¸ ${voteCount} ØµÙˆØª</div>
                ${buttons}
            `;

            return card;
        }

        async function showWinner(view) {
            try {
                const { data: votes, error: votesError } = await supabase
                    .from('votes')
                    .select('product_id');

                if (votesError) throw votesError;

                const voteCounts = {};
                votes.forEach(vote => {
                    voteCounts[vote.product_id] = (voteCounts[vote.product_id] || 0) + 1;
                });

                const winnerId = Object.keys(voteCounts).reduce((a, b) => 
                    voteCounts[a] > voteCounts[b] ? a : b, null);

                if (!winnerId) {
                    const container = view === 'admin' ? 
                        document.getElementById('adminWinner') : 
                        document.getElementById('userWinner');
                    container.innerHTML = '<p style="text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙˆØ§Øª Ø¨Ø¹Ø¯</p>';
                    return;
                }

                const { data: winner, error } = await supabase
                    .from('products')
                    .select('*')
                    .eq('id', winnerId)
                    .single();

                if (error) throw error;

                const container = view === 'admin' ? 
                    document.getElementById('adminWinner') : 
                    document.getElementById('userWinner');
                
                container.innerHTML = `
                    <div class="winner-card">
                        <h3>ğŸ† Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„ÙØ§Ø¦Ø² ğŸ†</h3>
                        <img src="${winner.file_url}" alt="${winner.name}" style="max-width:300px;border-radius:10px;margin:20px 0;">
                        <h2>${winner.name}</h2>
                        <p>${winner.description}</p>
                        <p><strong>Ø§Ù„Ø¨Ø§Ø¦Ø¹:</strong> ${winner.seller_email}</p>
                        <div style="font-size:1.5em;margin-top:20px;">
                            â¤ï¸ ${voteCounts[winnerId]} ØµÙˆØª
                        </div>
                    </div>
                `;
            } catch (error) {
                alert('Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„ÙØ§Ø¦Ø²: ' + error.message);
            }
        }
    </script>
</body>
</html>